# 2. Data storage

Date: 2021-08-14

## Status

Proposed

## РЕШЕНИЕ

### ХРАНИЛИЩЕ

Не принципиально, где хранить данные. Любое хранилище подойдет, если оно достаточно вместительное, и имеет разумную скорость скачивания. Можем начать с S3. 

### ДОСТУП И ОБЩИЙ ПОДХОД К РЕПЛИКАЦИИ

Доступ к нашему аккаунту в S3 будет ограничен. На начальной стадии мы можем позволять кому-то выкачивать данные прямо из S3, используя third-party tools (read-only access). Также, к аккаунту могут иметь доступ те кто чистят аккаунт (delete access. спорно. может, вообще не давать никому доступа к корневой реплике?). В дальнейшем, распространение данных будет осуществляться через реплики - например, если BYPOL хочет доступ к данным - мы будем им посылать реплику. Как именно - это будем уже с ними договариваться. С каждым потребителем - по своему договариваться и делать реплики удобные для них.

Для реплик нужно определить юнит репликации. Я предлагаю разбивать все данные в чанки по 2 часа каждый. Один чанк = одна папка верхнего уровня в хранилище, именованная так чтобы можно было сортировать папки по времени (YYYY-MM-DD-Hrs). Это удобно для пользователей которые качают данные вручную - к примеру, они логинятся в аккаунт и видят две новые папки. Сразу понятно, что это и есть данные которые им надо докачать. Если надо повторить репликацию - все довольно просто - надо еще раз скачать/послать все что в этой папке.

Вся текущая запись будет производиться в папку current. По истечении двух часов, программа будет переименовывать current в папку YYYY-MM-DD-Hrs, если та еще не существует, и создавать новую папку current.

Если в течение 2 часов никакие новые файлы не поступали, то папку YYYY-MM-DD-Hrs создавать не надо.  

### ДОПОЛНИТЕЛЬНЫЕ МЕТАДАННЫЕ

Для каждой картинки, есть следующие метаданные (вшиты в картинку):

1. Город.
Получен из приблизительной network локации, на последний момент считывания локации. Может быть отличен от текущего города но пока так пойдет
Default: Если города по какой-то причине нет, присваивать "Нет" или "Неизвестен"
2. Местное время округленное до 15(?) мин. 
Default: 00:00
3. UUID инсталляции программы на пользовательском устройстве, зашифрованный.
Default: ? в таких случаях, надо разбираться почему нет UIID 
4. Порядковый номер фотографии в сессии.
Число от 1 до maxint. Default: 0, но это ошибка
### СТРУКТУРА ПАПОК

Структура папок трехуровневая.

Верхний уровень - мы уже обсудили - это папка репликации в формате YYYY-MM-DD-Hrs. В сутках будет до 12 таких папок. 

Средний уровень - название города - или "Нет", если города нет.

Нижний уровень - Id пользователя, в нашем случае зашифрованный UUID

#### Фотографии

Сохраняются в папку нижнего уровня в формате имени: N - Time

где:

N - порядковый номер фото в сессии, с leading zeros, вроде N00001

Time - округленное местное время вроде 15-00  

Есть проблема, что имена файлов слишком похожие. Конечным пользователям, которые будут держать файлы в своем порядке, придется их часто переименовывать. Как разнообразить имена файлов? Нужен какой-то префикс имени, но из UIID его брать не стоит.

При сохранении файла, нужно убирать UUID из метаданных. 

### ЛОГИ

Каждую транзакцию и каждую ошибку нужно логировать, либо в текстовые файлы, либо сразу в AWS сервис для логирования. Текстовые файлы располагаются локально на серверах, пока никакого chainsaw/lumbejack настраивать не нужно. Желательно заводить новый файл для каждого часа логгирования.

## Decision

## Consequences
